local EspModule = {}

local Players = game:GetService("Players")
local VRService = game:GetService("VRService")

local Config = {
	EspEnabled = true,
	BoxesOn = false,
	NamesOn = false,
	ChamsOn = false,
	DotsOn = false,
	healthColored = false,
	DistanceOn = false,
	displayHealth = false,

	ChamsColor = Color3.fromRGB(255, 255, 255),
	ChamsOutlineColor = Color3.fromRGB(255, 255, 255),
	ChamsFillTransparency = 0.6,
	ChamsOutlineTransparency = 0.36,
	BoxTransparency = 0.39,
	DotTransparency = 0.4,
	BespColor = Color3.fromRGB(255, 255, 255),
	DespColor = Color3.fromRGB(255, 255, 255),
	NespColor = Color3.fromRGB(255, 255, 255),
}

local LocalPlayer = Players.LocalPlayer
local LocalPlayerName = LocalPlayer.Name
local RedC = Color3.fromRGB(255, 0, 0)

local function GetHealthPercent(Character)
	local Humanoid = Character:FindFirstChild("Humanoid") or Character:FindFirstChild("VRHealth")
	if not Humanoid then return 1 end
	if Humanoid:IsA("Humanoid") then
		return Humanoid.Health / Humanoid.MaxHealth
	end
	return Humanoid.Value / 100
end

local function GetHealthColor(healthPercent)
	return Color3.fromRGB(255 * (1 - healthPercent), 255 * healthPercent, 0)
end

local function GetEspColor(Player, Character, DefaultColor)
	if Config.healthColored then
		return GetHealthColor(GetHealthPercent(Character))
	end
	if workspace:FindFirstChild("PowerUps") then
		return (Player:GetAttribute("ModeTeam") == "Traitor") and RedC or DefaultColor
	elseif LocalPlayer.Team and Player.Team then
		return (LocalPlayer.Team.Name ~= Player.Team.Name) and RedC or DefaultColor
	end
	return DefaultColor
end

local function IsTraitor(Player)
	if workspace:FindFirstChild("PowerUps") then
		return Player:GetAttribute("ModeTeam") == "Traitor"
	elseif LocalPlayer.Team and Player.Team then
		return LocalPlayer.Team.Name ~= Player.Team.Name
	end
	return false
end

local function GetPart(Character)
	return Character:FindFirstChild("Torso") or Character:FindFirstChild("HumanoidRootPart") or Character.PrimaryPart
end

local function GetDistanceOffset(distance)
	if distance >= 1250 then
		return nil
	elseif distance > 650 then
		local t = (distance - 650) / 600
		return 10 + (7.5 * t)
	elseif distance > 550 then
		local t = (distance - 550) / 100
		return 5.5 + (11.25 * t)
	elseif distance > 400 then
		local t = (distance - 400) / 150
		return 4.8 + (1.75 * t)
	elseif distance > 200 then
		local t = (distance - 200) / 200
		return 4.6 + (0.5 * t)
	elseif distance > 100 then
		local t = (distance - 100) / 100
		return 4.4 + (1.0 * t)
	else
		return 4.4
	end
end

local function GetTextSize(distance)
	local baseSize = VRService.VREnabled and 13 or 16
	return math.min(12.99, baseSize)
end

local function CreateMainEspGui(Character, distance)
	local Part = GetPart(Character)
	if not Part then return nil end
	
	local offset = GetDistanceOffset(distance)
	if not offset then return nil end
	
	local Existing = Part:FindFirstChild("espmain")
	if Existing then
		Existing.StudsOffset = Vector3.new(0, offset, 0)
		return Existing
	end
	
	local Billboard = Instance.new("BillboardGui", Part)
	Billboard.Name = "espmain"
	Billboard.Adornee = Part
	Billboard.Size = UDim2.new(4, 0, 7, 0)
	Billboard.StudsOffset = Vector3.new(0, offset, 0)
	Billboard.AlwaysOnTop = true
	
	local Container = Instance.new("Frame", Billboard)
	Container.Name = "Container"
	Container.BackgroundTransparency = 1
	Container.Size = UDim2.new(1, 0, 1, 0)
	
	return Billboard
end

local function CreateChamsHighlight(Character, distance)
	local Player = Players:GetPlayerFromCharacter(Character)
	if not Player then return end

	if distance >= 1250 then
		local Existing = Character:FindFirstChild("chamshighlight")
		if Existing then
			Existing:Destroy()
		end
		return
	end

	if distance >= 650 then
		local Existing = Character:FindFirstChild("chamshighlight")
		if Existing then
			Existing:Destroy()
		end
		return
	end

	local ChamsFillColor, ChamsOutlineColor
	if Config.healthColored then
		local hc = GetHealthColor(GetHealthPercent(Character))
		ChamsFillColor = hc
		ChamsOutlineColor = hc
	elseif IsTraitor(Player) then
		ChamsFillColor = RedC
		ChamsOutlineColor = RedC
	else
		ChamsFillColor = Config.ChamsColor
		ChamsOutlineColor = Config.ChamsOutlineColor
	end

	local Existing = Character:FindFirstChild("chamshighlight")
	if Existing then
		Existing.FillColor = ChamsFillColor
		Existing.OutlineColor = ChamsOutlineColor
		Existing.FillTransparency = Config.ChamsFillTransparency
		Existing.OutlineTransparency = Config.ChamsOutlineTransparency
		return
	end

	local Highlight = Instance.new("Highlight")
	Highlight.Name = "chamshighlight"
	Highlight.Adornee = Character
	Highlight.FillColor = ChamsFillColor
	Highlight.FillTransparency = Config.ChamsFillTransparency
	Highlight.OutlineColor = ChamsOutlineColor
	Highlight.OutlineTransparency = Config.ChamsOutlineTransparency
	Highlight.Parent = Character
end

local function CreateBoxEsp(Character, distance)
	local Player = Players:GetPlayerFromCharacter(Character)
	if not Player then return end
	
	if distance >= 1250 then
		local Part = GetPart(Character)
		if Part then
			local MainGui = Part:FindFirstChild("espmain")
			if MainGui then
				local Container = MainGui:FindFirstChild("Container")
				if Container then
					local BoxFrame = Container:FindFirstChild("BoxFrame")
					if BoxFrame then
						BoxFrame.Visible = false
					end
				end
			end
		end
		return
	end
	
	if distance >= 650 then
		local Part = GetPart(Character)
		if Part then
			local MainGui = Part:FindFirstChild("espmain")
			if MainGui then
				local Container = MainGui:FindFirstChild("Container")
				if Container then
					local BoxFrame = Container:FindFirstChild("BoxFrame")
					if BoxFrame then
						BoxFrame.Visible = false
					end
				end
			end
		end
		return
	end
	
	local MainGui = CreateMainEspGui(Character, distance)
	if not MainGui then return end
	
	local Container = MainGui:FindFirstChild("Container")
	local BoxColor = GetEspColor(Player, Character, Config.BespColor)
	local Existing = Container:FindFirstChild("BoxFrame")
	
	if Existing then
		local Stroke = Existing:FindFirstChild("UIStroke")
		if Stroke then
			Stroke.Color = BoxColor
			Stroke.Transparency = Config.BoxTransparency
		end
		Existing.Visible = Config.BoxesOn
		return
	end
	
	local Frame = Instance.new("Frame", Container)
	Frame.Name = "BoxFrame"
	Frame.BackgroundTransparency = 1
	Frame.Size = UDim2.new(1, 0, 0.714, 0)
	Frame.Position = UDim2.new(0, 0, 0.286, 0)
	Frame.Visible = Config.BoxesOn
	
	local Stroke = Instance.new("UIStroke", Frame)
	Stroke.Thickness = 1.67
	Stroke.Transparency = Config.BoxTransparency
	Stroke.Color = BoxColor
end

local function CreateDotEsp(Character, distance)
	local Player = Players:GetPlayerFromCharacter(Character)
	if not Player then return end
	
	local Part = GetPart(Character)
	if not Part then return end
	
	if distance >= 1250 then
		local MainGui = Part:FindFirstChild("espmain")
		if MainGui then
			local Container = MainGui:FindFirstChild("Container")
			if Container then
				local DotFrame = Container:FindFirstChild("DotFrame")
				if DotFrame then
					DotFrame.Visible = false
				end
			end
		end
		return
	end
	
	if distance >= 650 then
		local MainGui = Part:FindFirstChild("espmain")
		if MainGui then
			local Container = MainGui:FindFirstChild("Container")
			if Container then
				local DotFrame = Container:FindFirstChild("DotFrame")
				if DotFrame then
					DotFrame.Visible = false
				end
			end
		end
		return
	end
	
	local MainGui = CreateMainEspGui(Character, distance)
	if not MainGui then return end
	
	local Container = MainGui:FindFirstChild("Container")
	local DotColor = GetEspColor(Player, Character, Config.DespColor)
	local Existing = Container:FindFirstChild("DotFrame")
	
	if Existing then
		Existing.BackgroundColor3 = DotColor
		Existing.Transparency = Config.DotTransparency
		Existing.Visible = Config.DotsOn
		return
	end

	local Dotf = Instance.new("Frame", Container)
	Dotf.Name = "DotFrame"
	Dotf.BackgroundColor3 = DotColor
	Dotf.Size = UDim2.new(0.1, 0, 0.1, 0)
	Dotf.Position = UDim2.new(0.45, 0, 0.5, 0)
	Dotf.Transparency = Config.DotTransparency
	Dotf.BorderSizePixel = 0
	Dotf.Visible = Config.DotsOn

	local Dotc = Instance.new("UICorner", Dotf)
	Dotc.CornerRadius = UDim.new(0.45, 0)
end

local function CreateNameEsp(Character, distance)
	local Player = Players:GetPlayerFromCharacter(Character)
	if not Player then return end
	
	local Part = GetPart(Character)
	local Head = Character:FindFirstChild("Head")
	if not Head or not Part then return end
	
	if distance >= 1250 then
		local MainGui = Part:FindFirstChild("espmain")
		if MainGui then
			local Container = MainGui:FindFirstChild("Container")
			if Container then
				local NameLabel = Container:FindFirstChild("NameLabel")
				if NameLabel then
					NameLabel.Visible = false
				end
			end
		end
		return
	end
	
	if distance >= 650 then
		local MainGui = Part:FindFirstChild("espmain")
		if MainGui then
			local Container = MainGui:FindFirstChild("Container")
			if Container then
				local NameLabel = Container:FindFirstChild("NameLabel")
				if NameLabel then
					NameLabel.Visible = false
				end
			end
		end
		return
	end
	
	local MainGui = CreateMainEspGui(Character, distance)
	if not MainGui then return end
	
	local Container = MainGui:FindFirstChild("Container")
	local NameColor = GetEspColor(Player, Character, Config.NespColor)
	local Existing = Container:FindFirstChild("NameLabel")
	
	local parts = {}
	
	if Config.NamesOn then
		table.insert(parts, "Name: " .. Player.Name:upper())
	end
	
	if Config.DistanceOn then
		table.insert(parts, "Distance: " .. math.floor(distance))
	end
	
	if Config.displayHealth then
		local healthPercent = GetHealthPercent(Character)
		local Humanoid = Character:FindFirstChild("Humanoid") or Character:FindFirstChild("VRHealth")
		local healthValue = 100
		if Humanoid then
			if Humanoid:IsA("Humanoid") then
				healthValue = math.floor(Humanoid.Health)
			else
				healthValue = math.floor(Humanoid.Value)
			end
		end
		table.insert(parts, "Health: " .. healthValue)
	end
	
	local displayText = ""
	if #parts > 0 then
		displayText = "| " .. table.concat(parts, " | ") .. " |"
	end
	
	local textSize = GetTextSize(distance)
	
	if Existing then
		Existing.TextColor3 = NameColor
		Existing.Text = displayText
		Existing.TextSize = textSize
		Existing.Visible = Config.NamesOn or Config.DistanceOn or Config.displayHealth
		return
	end
	
	local Namel = Instance.new("TextLabel", Container)
	Namel.Name = "NameLabel"
	Namel.Size = UDim2.new(1, 0, 0.143, 0)
	Namel.Position = UDim2.new(0, 0, 0.286, 0)
	Namel.BorderSizePixel = 0
	Namel.BackgroundTransparency = 1
	Namel.Text = displayText
	Namel.TextColor3 = NameColor
	Namel.TextStrokeTransparency = 0.5
	Namel.Font = Enum.Font.SourceSansBold
	Namel.TextSize = textSize
	Namel.Visible = Config.NamesOn or Config.DistanceOn or Config.displayHealth
end

local function ClearEsp(Type)
	for _, Plr in pairs(Players:GetPlayers()) do
		if Plr.Name ~= LocalPlayerName and Plr.Character then
			local Part = GetPart(Plr.Character)
			if Part then
				local MainGui = Part:FindFirstChild("espmain")
				if MainGui then
					local Container = MainGui:FindFirstChild("Container")
					if Container then
						if Type == 1 then
							local BoxFrame = Container:FindFirstChild("BoxFrame")
							if BoxFrame then BoxFrame.Visible = false end
						elseif Type == 2 then
							local NameLabel = Container:FindFirstChild("NameLabel")
							if NameLabel then
								if Config.DistanceOn then
									local localPart = LocalPlayer.Character and GetPart(LocalPlayer.Character)
									if localPart and Part then
										local distance = math.floor((localPart.Position - Part.Position).Magnitude)
										NameLabel.Text = "[" .. distance .. "]"
									end
									NameLabel.Visible = true
								else
									NameLabel.Visible = false
								end
							end
						elseif Type == 3 then
							local Chamsesp = Plr.Character:FindFirstChild("chamshighlight")
							if Chamsesp then Chamsesp:Destroy() end
						elseif Type == 4 then
							local DotFrame = Container:FindFirstChild("DotFrame")
							if DotFrame then DotFrame.Visible = false end
						elseif Type == 5 then
							local NameLabel = Container:FindFirstChild("NameLabel")
							if NameLabel then
								if Config.NamesOn then
									NameLabel.Text = Plr.Name:upper()
									NameLabel.Visible = true
								else
									NameLabel.Visible = false
								end
							end
						end
					end
				end
			end
		end
	end
end

local function UpdateAllEsp()
	if not Config.EspEnabled then return end
	
	local localPart = LocalPlayer.Character and GetPart(LocalPlayer.Character)
	if not localPart then return end
	
	for _, Plr in pairs(Players:GetPlayers()) do
		if Plr.Name ~= LocalPlayerName and Plr.Character then
			local targetPart = GetPart(Plr.Character)
			if targetPart then
				local distance = (localPart.Position - targetPart.Position).Magnitude
				if distance < 1250 then
					CreateBoxEsp(Plr.Character, distance)
					CreateNameEsp(Plr.Character, distance)
					if Config.ChamsOn then CreateChamsHighlight(Plr.Character, distance) end
					CreateDotEsp(Plr.Character, distance)
				end
			end
		end
	end
end

local function EditConfig(option, value)
	if Config[option] ~= nil then
		Config[option] = value
	end
end

local function GetConfig()
	return Config
end

EspModule.GetConfig = GetConfig
EspModule.EditConfig = EditConfig
EspModule.UpdateAllEsp = UpdateAllEsp
EspModule.ClearEsp = ClearEsp
EspModule.CreateChamsHighlight = CreateChamsHighlight
EspModule.CreateBoxEsp = CreateBoxEsp
EspModule.CreateDotEsp = CreateDotEsp
EspModule.CreateNameEsp = CreateNameEsp


return EspModule
