local EspModule = {}

local Players = game:GetService("Players")
local VRService = game:GetService("VRService")

if _G.EspModuleInstance then
	pcall(function()
		if _G.EspModuleInstance.Cleanup then
			_G.EspModuleInstance.Cleanup()
		end
	end)
	pcall(function()
		for _, Plr in pairs(Players:GetPlayers()) do
			if Plr.Character then
				for _, desc in pairs(Plr.Character:GetDescendants()) do
					if desc.Name == "espmain" or desc.Name == "espbox" or desc.Name == "espdot" or desc.Name == "chamshighlight" or desc.Name == "nameesp" then
						desc:Destroy()
					end
				end
			end
		end
	end)
	task.wait(0.1)
end

local Config = {
    -- States
	EspEnabled = true,
    BoxesOn = false,
	NamesOn = false,
	ChamsOn = false,
	DotsOn = false,
	healthColored = false,
	DistanceOn = false,

    -- Colors
	ChamsColor = Color3.fromRGB(255, 255, 255),
	ChamsOutlineColor = Color3.fromRGB(255, 255, 255),
	ChamsFillTransparency = 0.6,
	ChamsOutlineTransparency = 0.36,
	BoxTransparency = 0.39,
	DotTransparency = 0.4,
	BespColor = Color3.fromRGB(255, 255, 255),
	DespColor = Color3.fromRGB(255, 255, 255),
	NespColor = Color3.fromRGB(255, 255, 255),
	RLineColor = Color3.new(1, 0, 0),
	LLineColor = Color3.new(1, 0, 0),
}

local LocalPlayer = Players.LocalPlayer
local LocalPlayerName = LocalPlayer.Name
local RedC = Color3.fromRGB(255, 0, 0)

local EspCache = {
    Boxes = {},
    Names = {},
    Chams = {},
    Dots = {},
    HealthBars = {},
    MainGuis = {}
}

-- Helper Functions
function ColorCheck(Player, EnemyColor, FriendlyColor)
	if workspace:FindFirstChild("PowerUps") then
		return (Player:GetAttribute("ModeTeam") == "Traitor") and EnemyColor or FriendlyColor
	elseif LocalPlayer.Team and Player.Team then
		return (LocalPlayer.Team.Name ~= Player.Team) and EnemyColor or FriendlyColor
	else
		return FriendlyColor
	end
end

function ColorMinus(Color, Step)
	return Color3.fromRGB(Color.R - Step, Color.G - Step, Color.B - Step)
end

function GetPlayerKey(Player)
    return Player.UserId
end

function CleanupPlayerCache(Player)
    local key = GetPlayerKey(Player)
    if EspCache.Boxes[key] then
        local frame = EspCache.Boxes[key]
        local container = frame.Parent
        if container then
            local billboard = container.Parent
            if billboard and billboard:IsA("BillboardGui") then
                billboard:Destroy()
            else
                frame:Destroy()
            end
        else
            frame:Destroy()
        end
    end
    if EspCache.Names[key] then EspCache.Names[key]:Destroy() end
    if EspCache.Chams[key] then EspCache.Chams[key]:Destroy() end
    if EspCache.Dots[key] then
        local frame = EspCache.Dots[key]
        local container = frame.Parent
        if container then
            local billboard = container.Parent
            if billboard and billboard:IsA("BillboardGui") then
                billboard:Destroy()
            else
                frame:Destroy()
            end
        else
            frame:Destroy()
        end
    end
    if EspCache.HealthBars[key] then EspCache.HealthBars[key]:Destroy() end
    if EspCache.MainGuis[key] then EspCache.MainGuis[key]:Destroy() end
    
    EspCache.Boxes[key] = nil
    EspCache.Names[key] = nil
    EspCache.Chams[key] = nil
    EspCache.Dots[key] = nil
    EspCache.HealthBars[key] = nil
    EspCache.MainGuis[key] = nil
end

local function ToggleEspVisibility(cacheTable, visible, customHandler)
    for _, component in pairs(cacheTable) do
        if component and component.Parent then
            if customHandler then
                customHandler(component, visible)
            else
                component.Visible = visible
            end
        end
    end
end

function ToggleBoxVisibility(visible)
    ToggleEspVisibility(EspCache.Boxes, visible)
end

function ToggleNameVisibility(visible)
    ToggleEspVisibility(EspCache.Names, visible or Config.DistanceOn)
end

function ToggleChamVisibility(visible)
    ToggleEspVisibility(EspCache.Chams, visible, function(highlight, vis)
        highlight.Enabled = vis
    end)
end

function ToggleDotVisibility(visible)
    ToggleEspVisibility(EspCache.Dots, visible)
end

function ToggleHealthBarVisibility(visible)
	return
end

function GetHealthColor(healthPercent)
    local r = math.clamp(255 * (1 - healthPercent), 0, 255)
    local g = math.clamp(255 * healthPercent, 0, 255)
    return Color3.fromRGB(r, g, 0)
end

function CreateChamsHighlight(Character)
    local Player = game.Players:GetPlayerFromCharacter(Character)
    if not Player then return end
    
    local key = GetPlayerKey(Player)
    local Existing = EspCache.Chams[key]
    
    local ChamsFillColor, ChamsOutlineColor
    
    local isTraitor = false
    if workspace:FindFirstChild("PowerUps") then
        isTraitor = (Player:GetAttribute("ModeTeam") == "Traitor")
    elseif LocalPlayer.Team and Player.Team then
        isTraitor = (LocalPlayer.Team.Name ~= Player.Team.Name)
    end

    if isTraitor then
        ChamsFillColor = Color3.fromRGB(255, 0, 0)
        ChamsOutlineColor = Color3.fromRGB(255, 0, 0)
    elseif Config.healthColored then
        local Humanoid = Character:FindFirstChild("Humanoid") or Character:FindFirstChild("VRHealth")
        local healthPercent = 1
        if Humanoid then
            healthPercent = Humanoid:IsA("Humanoid") and (Humanoid.Health / Humanoid.MaxHealth) or (Humanoid.Value / 100)
        end
        ChamsFillColor = GetHealthColor(healthPercent)
        ChamsOutlineColor = GetHealthColor(healthPercent)
    else
        ChamsFillColor = Config.ChamsColor or Color3.fromRGB(0, 170, 255)
        ChamsOutlineColor = Config.ChamsOutlineColor or Color3.fromRGB(0, 85, 128)
    end

    local ChamsFillTransparency = Config.ChamsFillTransparency or 0.6
    local ChamsOutlineTransparency = Config.ChamsOutlineTransparency or 0.36

    if Existing and Existing.Parent then
        Existing.FillColor = ChamsFillColor
        Existing.OutlineColor = ChamsOutlineColor
        Existing.FillTransparency = ChamsFillTransparency
        Existing.OutlineTransparency = ChamsOutlineTransparency
        Existing.Enabled = Config.ChamsOn
        return
    end

    local Highlight = Instance.new("Highlight")
    Highlight.Name = "chamshighlight"
    Highlight.Adornee = Character
    Highlight.FillColor = ChamsFillColor
    Highlight.FillTransparency = ChamsFillTransparency
    Highlight.OutlineColor = ChamsOutlineColor
    Highlight.OutlineTransparency = ChamsOutlineTransparency
    Highlight.Enabled = Config.ChamsOn
    Highlight.Parent = Character
    
    EspCache.Chams[key] = Highlight
end

function CreateMainEspGui(Character)
	local Part = Character:FindFirstChild("Torso") or Character:FindFirstChild("HumanoidRootPart") or Character.PrimaryPart
	if not Part then return nil end
	
	local Player = game.Players:GetPlayerFromCharacter(Character)
	if not Player then return nil end
	
	local key = GetPlayerKey(Player)
	local Existing = EspCache.MainGuis[key]
	if Existing and Existing.Parent then
		Existing.MaxDistance = 595
		return Existing
	end
	
	local Billboard = Instance.new("BillboardGui", Part)
	Billboard.Name = "espmain"
	Billboard.Adornee = Part
	Billboard.Size = UDim2.new(4, 0, 7, 0)
	Billboard.StudsOffset = Vector3.new(0, 4.4, 0)
	Billboard.AlwaysOnTop = true
	Billboard.MaxDistance = 595
	
	local Container = Instance.new("Frame", Billboard)
	Container.Name = "Container"
	Container.BackgroundTransparency = 1
	Container.Size = UDim2.new(1, 0, 1, 0)
	
	EspCache.MainGuis[key] = Billboard
	return Billboard
end

function CreateBoxEsp(Character)
	local Part = Character:FindFirstChild("Torso") or Character:FindFirstChild("HumanoidRootPart") or Character.PrimaryPart
	local Player = game.Players:GetPlayerFromCharacter(Character)
	if not Player or not Part then return end
	
	local key = GetPlayerKey(Player)
	local BoxEspColor = ColorCheck(Player, RedC, Config.BespColor)
	
	if Config.healthColored and BoxEspColor ~= RedC then
		local Humanoid = Character:FindFirstChild("Humanoid") or Character:FindFirstChild("VRHealth")
		if Humanoid then
			local healthPercent = Humanoid:IsA("Humanoid") and (Humanoid.Health / Humanoid.MaxHealth) or (Humanoid.Value / 100)
			BoxEspColor = GetHealthColor(healthPercent)
		end
	end
	
	local Existing = EspCache.Boxes[key]
	
	if Existing and Existing.Parent then
		local Container = Existing.Parent
		local Billboard = Container and Container.Parent
		if Billboard and Billboard:IsA("BillboardGui") then
			Billboard.MaxDistance = 595
		end
		local Stroke = Existing:FindFirstChild("UIStroke")
		if Stroke then
			Stroke.Color = BoxEspColor
			Stroke.Transparency = Config.BoxTransparency
		end
		Existing.Visible = Config.BoxesOn
		return
	end
	
	local Billboard = Instance.new("BillboardGui", Part)
	Billboard.Name = "espbox"
	Billboard.Adornee = Part
	Billboard.Size = UDim2.new(4, 0, 6, 0)
	Billboard.StudsOffset = Vector3.new(0, 0, 0)
	Billboard.AlwaysOnTop = true
	Billboard.MaxDistance = 595
	
	local Container = Instance.new("Frame", Billboard)
	Container.Name = "Container"
	Container.BackgroundTransparency = 1
	Container.Size = UDim2.new(1, 0, 1, 0)
	
	local Frame = Instance.new("Frame", Container)
	Frame.Name = "BoxFrame"
	Frame.BackgroundTransparency = 1
	Frame.Size = UDim2.new(1, 0, 1, 0)
	Frame.Visible = Config.BoxesOn
	
	local Stroke = Instance.new("UIStroke", Frame)
	Stroke.Thickness = 1.67
	Stroke.Transparency = Config.BoxTransparency
	Stroke.Color = BoxEspColor
	
	EspCache.Boxes[key] = Frame
end

function CreateDotEsp(Character)
	local Part = Character:FindFirstChild("Torso") or Character:FindFirstChild("HumanoidRootPart") or Character:FindFirstChild("Root")
	local Player = game.Players:GetPlayerFromCharacter(Character)
	if not Player or not Part then return end
	
	local key = GetPlayerKey(Player)
	local DotEspColor = ColorCheck(Player, RedC, Config.DespColor)
	
	if Config.healthColored and DotEspColor ~= RedC then
		local Humanoid = Character:FindFirstChild("Humanoid") or Character:FindFirstChild("VRHealth")
		if Humanoid then
			local healthPercent = Humanoid:IsA("Humanoid") and (Humanoid.Health / Humanoid.MaxHealth) or (Humanoid.Value / 100)
			DotEspColor = GetHealthColor(healthPercent)
		end
	end
	
	local Existing = EspCache.Dots[key]
	
	if Existing and Existing.Parent then
		local Container = Existing.Parent
		local Billboard = Container and Container.Parent
		if Billboard and Billboard:IsA("BillboardGui") then
			Billboard.MaxDistance = 595
		end
		Existing.BackgroundColor3 = DotEspColor
		Existing.Transparency = Config.DotTransparency
		Existing.Visible = Config.DotsOn
		return
	end

	local Billboard = Instance.new("BillboardGui", Part)
	Billboard.Name = "espdot"
	Billboard.Adornee = Part
	Billboard.Size = UDim2.new(1, 0, 1, 0)
	Billboard.StudsOffset = Vector3.new(0, 0, 0)
	Billboard.AlwaysOnTop = true
	Billboard.MaxDistance = 595
	
	local Container = Instance.new("Frame", Billboard)
	Container.Name = "Container"
	Container.BackgroundTransparency = 1
	Container.Size = UDim2.new(1, 0, 1, 0)

	local Dotf = Instance.new("Frame", Container)
	Dotf.Name = "DotFrame"
	Dotf.BackgroundColor3 = DotEspColor
	Dotf.Size = UDim2.new(0.1, 21, 0.1, 21)
	Dotf.Position = UDim2.new(0.45, 0, 0.5, 0)
	Dotf.Transparency = Config.DotTransparency
	Dotf.BorderSizePixel = 0
	Dotf.Visible = Config.DotsOn

	local Dotc = Instance.new("UICorner", Dotf)
	Dotc.CornerRadius = UDim.new(0.45, 0)
	
	EspCache.Dots[key] = Dotf
end

function CreateNameEsp(Character)
	local Part = Character:FindFirstChild("Torso") or Character:FindFirstChild("HumanoidRootPart")
	local Head = Character:FindFirstChild("Head")
	if not Head or not Head.Parent then return end
	
	local Player = game.Players:GetPlayerFromCharacter(Character)
	if not Player then return end
	
	local key = GetPlayerKey(Player)
	local NameEspColor = ColorCheck(Player, RedC, Config.NespColor)
	
	if Config.healthColored and NameEspColor ~= RedC then
		local Humanoid = Character:FindFirstChild("Humanoid") or Character:FindFirstChild("VRHealth")
		if Humanoid then
			local healthPercent = Humanoid:IsA("Humanoid") and (Humanoid.Health / Humanoid.MaxHealth) or (Humanoid.Value / 100)
			NameEspColor = GetHealthColor(healthPercent)
		end
	end
	
	local MainGui = CreateMainEspGui(Character)
	if not MainGui then return end
	
	local Container = MainGui:FindFirstChild("Container")
	local Existing = EspCache.Names[key]
	
	local playerName = Player.Name and Player.Name:upper() or ""
	local distanceText = ""
	
	if Config.DistanceOn and LocalPlayer.Character and Part then
		local localTorso = LocalPlayer.Character:FindFirstChild("Torso") or LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
		if localTorso then
			local distance = math.floor((localTorso.Position - Part.Position).Magnitude)
			distanceText = " - [" .. tostring(distance) .. "]"
		end
	end
	
	if Existing and Existing.Parent then
		Existing.TextColor3 = NameEspColor
		if Config.NamesOn then
			Existing.Text = playerName .. distanceText
		elseif Config.DistanceOn then
			Existing.Text = distanceText:sub(4)
		else
			Existing.Text = ""
		end
		Existing.Visible = Config.NamesOn or Config.DistanceOn
		return
	end
	
	local Namel = Instance.new("TextLabel", Container)
	Namel.Name = "NameLabel"
	Namel.Size = UDim2.new(1, 0, 0.143, 0)
	Namel.Position = UDim2.new(0, 0, 0, 0)
	Namel.BorderSizePixel = 0
	Namel.BackgroundTransparency = 1
	if Config.NamesOn then
		Namel.Text = playerName .. distanceText
	elseif Config.DistanceOn then
		Namel.Text = distanceText:sub(4)
	else
		Namel.Text = ""
	end
	Namel.TextColor3 = NameEspColor
	Namel.TextStrokeTransparency = 0.5
	Namel.Font = Enum.Font.SourceSansBold
	Namel.TextSize = VRService.VREnabled and 9 or 14
	Namel.Visible = Config.NamesOn or Config.DistanceOn
	
	EspCache.Names[key] = Namel
end

function CreateHealthBar(Character)
	return
end

function CreateDistanceDisplay(Character)
	local Part = Character:FindFirstChild("Torso") or Character:FindFirstChild("HumanoidRootPart")
	if not Part then return end
	
	local MainGui = CreateMainEspGui(Character)
	if not MainGui then return end
	
	local Container = MainGui:FindFirstChild("Container")
	local NameLabel = Container:FindFirstChild("NameLabel")
	
	if not NameLabel then
		CreateNameEsp(Character)
		return
	end
	
	local Player = game.Players:GetPlayerFromCharacter(Character)
	local playerName = Player.Name and Player.Name:upper() or ""
	local distanceText = ""
	
	if Config.DistanceOn and LocalPlayer.Character then
		local localTorso = LocalPlayer.Character:FindFirstChild("Torso") or LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
		if localTorso then
			local distance = math.floor((localTorso.Position - Part.Position).Magnitude)
			distanceText = " - [" .. tostring(distance) .. "]"
		end
	end
	
	if Config.NamesOn then
		NameLabel.Text = playerName .. distanceText
	elseif Config.DistanceOn then
		NameLabel.Text = distanceText:sub(4)
	else
		NameLabel.Text = ""
	end
	
	NameLabel.Visible = Config.NamesOn or Config.DistanceOn
end

function ClearEsp(Type)
	if Type == 1 then
		ToggleBoxVisibility(false)
	elseif Type == 2 then
		ToggleNameVisibility(Config.DistanceOn)
	elseif Type == 3 then
		ToggleChamVisibility(false)
	elseif Type == 4 then
		ToggleDotVisibility(false)
	elseif Type == 5 then
		ToggleHealthBarVisibility(false)
	elseif Type == 6 then
		ToggleNameVisibility(Config.NamesOn)
	end
end

local LastEspUpdate = 0
function UpdateAllEsp()
	if not Config.EspEnabled then return end
	local CT = tick()
	
	for _, Plr in pairs(game.Players:GetPlayers()) do
		if Plr.Name ~= LocalPlayerName and Plr.Character then
			CreateBoxEsp(Plr.Character)
			CreateNameEsp(Plr.Character)
			if Config.ChamsOn then CreateChamsHighlight(Plr.Character) end
			CreateDotEsp(Plr.Character)
			CreateHealthBar(Plr.Character)
			CreateDistanceDisplay(Plr.Character)
		end
	end
	
	if CT - LastEspUpdate >= 2 then
		LastEspUpdate = CT
	end
end

function EditConfig(option, value)
	if Config[option] ~= nil then
		Config[option] = value
		
		if option == "BoxesOn" then
			ToggleBoxVisibility(value)
		elseif option == "NamesOn" then
			ToggleNameVisibility(value or Config.DistanceOn)
		elseif option == "ChamsOn" then
			ToggleChamVisibility(value)
		elseif option == "DotsOn" then
			ToggleDotVisibility(value)
		elseif option == "healthColored" then
			UpdateAllEsp()
		elseif option == "DistanceOn" then
			ToggleNameVisibility(Config.NamesOn or value)
		end
	end
end

function GetConfig()
    return Config
end

local espConnections = {}
local playerCharacterConnections = {}

local function cleanupAllConnections()
    if espConnections.playerRemoving then
        espConnections.playerRemoving:Disconnect()
        espConnections.playerRemoving = nil
    end
    if espConnections.playerAdded then
        espConnections.playerAdded:Disconnect()
        espConnections.playerAdded = nil
    end
    for player, conn in pairs(playerCharacterConnections) do
        if conn then
            conn:Disconnect()
        end
        playerCharacterConnections[player] = nil
    end
    table.clear(playerCharacterConnections)
end

espConnections.playerRemoving = Players.PlayerRemoving:Connect(function(Player)
    CleanupPlayerCache(Player)
    if playerCharacterConnections[Player] then
        playerCharacterConnections[Player]:Disconnect()
        playerCharacterConnections[Player] = nil
    end
end)

for _, Player in pairs(Players:GetPlayers()) do
    if Player ~= LocalPlayer then
        playerCharacterConnections[Player] = Player.CharacterRemoving:Connect(function()
            CleanupPlayerCache(Player)
        end)
    end
end

espConnections.playerAdded = Players.PlayerAdded:Connect(function(Player)
    if Player ~= LocalPlayer then
        playerCharacterConnections[Player] = Player.CharacterRemoving:Connect(function()
            CleanupPlayerCache(Player)
        end)
    end
end)

function Cleanup()
    cleanupAllConnections()
    for _, cacheTable in pairs(EspCache) do
        for key, component in pairs(cacheTable) do
            if component and component.Parent then
                pcall(function() component:Destroy() end)
            end
            cacheTable[key] = nil
        end
        table.clear(cacheTable)
    end
end

EspModule.GetConfig = GetConfig
EspModule.EditConfig = EditConfig
EspModule.UpdateAllEsp = UpdateAllEsp
EspModule.ClearEsp = ClearEsp
EspModule.CreateChamsHighlight = CreateChamsHighlight
EspModule.CreateBoxEsp = CreateBoxEsp
EspModule.CreateDotEsp = CreateDotEsp
EspModule.CreateHealthBar = CreateHealthBar
EspModule.CreateDistanceDisplay = CreateDistanceDisplay
EspModule.CleanupPlayerCache = CleanupPlayerCache
EspModule.ToggleBoxVisibility = ToggleBoxVisibility
EspModule.ToggleNameVisibility = ToggleNameVisibility
EspModule.ToggleChamVisibility = ToggleChamVisibility
EspModule.ToggleDotVisibility = ToggleDotVisibility
EspModule.ToggleHealthBarVisibility = ToggleHealthBarVisibility
EspModule.Cleanup = Cleanup

_G.EspModuleInstance = EspModule

return EspModule
